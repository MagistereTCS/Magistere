define(["jquery","core/templates","media_videojs/video-lazy"],function(a,b,c){function d(b,c){var e=a("#search-input").val(),g=a("#search-select").val(),h=0!=a("#search-select option[value=archive]").length;a(window).on("orientationchange",function(b){screen.width<960&&(90==window.orientation?(a(".item.course-tile").addClass("list-group-item"),a(".grid").removeClass("selected-view"),a(".list").addClass("selected-view")):(a(".item.course-tile").removeClass("list-group-item"),a(".list").removeClass("selected-view"),a(".grid").addClass("selected-view"),a(".item.course-tile").addClass("grid-group-item")))}),"archive"!=g&&"favoris"!=g&&h?a("#btn_showArchivedCourses").show():a("#btn_showArchivedCourses").hide(),a("#btn_showArchivedCourses").on("click",function(){a("#search-select").val("archive"),d(b,c)}),f(b,"main",e,g,c)}function e(c,d,e,f){var g=a(".user-view-pref").attr("v");b.render(c,d).then(function(b,c){f.html(b),k(g),a("<script>").append(c).appendTo("body"),f.fadeIn(100,function(){j(),o(e),m(e),n(e)})})}function f(c,d,f,j,k){var l=a(".courses-content");a.ajax({type:"POST",url:c,data:JSON.stringify({module:d,search:f,filter:j}),dataType:"json",beforeSend:function(){a(".spinner").show()},success:function(m){if(courses=m,courses.error)a(".archived-course-header").hide(),l.html("Une erreur s'est produite. Merci de rafraichir la page.");else if(0!=f.length)if(courses.courses.length>0)"archive"==j?l.addClass("archived"):l.removeClass("archived"),"favoris"==j?(a(".archived-course-header").show(),h(c,d,f,j,k)):i(),e("local_myindex/courses",courses,c,l);else if("favoris"==j)l.empty(),a(".archived-course-header").show(),g(c,d,f,j,k,courses.courses.length),h(c,d,f,j,k);else{i();var n={search:f,course_offers_url:k};b.render("local_myindex/no_course",n).then(function(b,c){l.html(b),a("<script>").append(c).appendTo("body"),l.fadeIn(400)})}else{var o=0!=a("#search-select option[value=archive]").length;if(0==courses.courses.length)if("favoris"==j)l.empty(),g(c,d,f,j,k,courses.courses.length),o&&(a(".archived-course-header").show(),h(c,d,f,j,k));else{i();var n={"no-course":!0,course_offers_url:k};b.render("local_myindex/no_course",n).then(function(b,c){l.html(b),a("<script>").append(c).appendTo("body"),l.fadeIn(400)})}else"archive"==j?l.addClass("archived"):l.removeClass("archived"),"favoris"==j?o&&(a(".archived-course-header").show(),h(c,d,f,j,k)):i(),e("local_myindex/courses",courses,c,l)}a(".spinner").fadeOut(800)},error:function(a){console.log(a)}})}function g(c,d,f,g,h,j){var k=a(".myindex-archived-content");a.ajax({type:"POST",url:c,data:JSON.stringify({module:d,search:f,filter:g,archive:!0}),dataType:"json",success:function(d){if(courses=d,courses.error)i(),k.html("Une erreur s'est produite sur les parcours favoris archivés. Merci de rafraichir la page.");else if(0!=f.length){if(courses.courses.length>0)e("local_myindex/archived_courses",courses,c,k),a(".archived-course-header").show();else if(i(),0==j){k=a(".courses-content");var g={search:f,course_offers_url:h};b.render("local_myindex/no_course",g).then(function(b,c){k.html(b),a("<script>").append(c).appendTo("body"),k.fadeIn(400)})}}else if(0==courses.courses.length){if(i(),0==j){k=a(".courses-content");var g={"no-course":!0,course_offers_url:h};b.render("local_myindex/no_course",g).then(function(b,c){k.html(b),a("<script>").append(c).appendTo("body"),k.fadeIn(400)})}}else e("local_myindex/archived_courses",courses,c,k),a(".archived-course-header").show()},error:function(a){console.log(a)}})}function h(b,c,d,e,f,h){var i=a(".myindex-archived-content");a(".archived-courses-link").off("click"),a(".archived-courses-link").on("click",function(j){a("#collapseArchivedCourses").find(".spinner").show(),i.empty(),a("#collapseArchivedCourses").hasClass("in")?(a(this).addClass("collapsed"),a("#collapseArchivedCourses").removeClass("in")):(a(this).removeClass("collapsed"),a("#collapseArchivedCourses").addClass("in"),g(b,c,d,e,f,h)),a("#collapseArchivedCourses").find(".spinner").fadeOut(800)})}function i(){a(".archived-course-header").hide(),a(".archived-courses-link").addClass("collapsed"),a("#collapseArchivedCourses").removeClass("in"),a(".myindex-archived-content").empty()}function j(){a(".item.course-tile").each(function(){var b=parseInt(a(this).find(".progress-user").attr("data-pct")),c=a(this).find("#svg #bar");isNaN(b)&&(b=0);var d=c.attr("r"),e=Math.PI*(2*d);b<0&&(b=0),b>100&&(b=100);var f=(100-b)/100*e;c.css({strokeDashoffset:f})})}function k(b){"list"==b?(a(".item.course-tile").addClass("list-group-item"),a(".grid").removeClass("selected-view"),a(".list").addClass("selected-view")):(a(".item.course-tile").removeClass("list-group-item"),a(".list").removeClass("selected-view"),a(".grid").addClass("selected-view"),a(".item.course-tile").addClass("grid-group-item"))}function l(b,c){a(".search .fa-search").off("click"),a(".search .fa-search").on("click",function(){(a("#search-input").val().length>2||0==a("#search-input").val().length)&&d(b,c)}),a("#search-input").bind("enterKey",function(){(a("#search-input").val().length>2||0==a("#search-input").val().length)&&d(b,c)}),a("#search-input").keyup(function(b){13===b.keyCode&&a(this).trigger("enterKey")}),a("#search-select").on("change",function(){d(b,c)})}function m(b){a("i.fav-icon").off("click"),a("i.fav-icon").on("click",function(c){c.preventDefault();var d=a(this),e=a(this).parents(".card-body").find(".show-detail a").attr("ref-modal-source"),f=a(this).parents(".card-body").find(".show-detail a").attr("ref-modal-id"),g=!1;d.hasClass("unfav")&&(g=!0),a.ajax({type:"POST",url:b,data:'{"module":"fav","ac":"'+e+'","id":"'+f+'","action":'+g+"}",dataType:"json",success:function(a){1==a.value?(d.parents(".card-body").find("i.fav-icon").addClass("fav"),d.parents(".card-body").find("i.fav-icon").removeClass("unfav"),d.parents(".card-body").find("i.fav-icon").attr("title","Retirer de mes parcours favoris")):(d.parents(".card-body").find("i.fav-icon").addClass("unfav"),d.parents(".card-body").find("i.fav-icon").removeClass("fav"),d.parents(".card-body").find("i.fav-icon").attr("title","Ajouter à mes parcours favoris"))},error:function(a){console.log(a)}})})}function n(b){a(".change-view button").on("click",function(){if(!a(this).hasClass("selected-view")){var c="grid";a(this).hasClass("list")&&(c="list"),k(c),a.ajax({type:"POST",url:b,data:'{"module":"viewmod","mod":"'+c+'"}',dataType:"json",success:function(b){a(".user-view-pref").attr("v",b.value)},error:function(a){console.log(a)}})}})}function o(d){a("#region-main").off("click"),a("#region-main").on("click",'a[ref-bs-element="modal"]',function(){var e=a(this).attr("ref-modal-id"),f=a(this).attr("ref-modal-source"),g="#"+a(this).attr("ref-modal");a.ajax({type:"POST",url:d,data:'{"module":"modal","ac":"'+f+'","id":'+e+"}",dataType:"json",success:function(d){var e=d,f="local_myindex/modal";b.render(f,e).then(function(b,d){a("#myModal").html(b),document.getElementsByClassName("video-js")[0]&&c(document.getElementsByClassName("video-js")[0],{},function(){}),a(g).modal("show"),a(g+" .modal").on("shown.bs.modal",function(){a("body").addClass("modal-open")}),a(g+" .modal").on("hidden.bs.modal",function(){history.pushState("",document.title,window.location.pathname+window.location.search),a("body").removeClass("modal-open")}),a("<script>").append(d).appendTo("body")})},error:function(a){console.log(a)}})})}return{init:function(a,b){d(a,b)},validateform:function(a,b){l(a,b)}}});