define(["jquery","core/str","core/notification","core/ajax","local_supervision_tool/jtable","local_magisterelib/jquery.loadingModal"],function(a,b,c,d){function e(b,c){var d=a("#filterresults").jtable({paging:!0,pageSize:10,pageSizes:[10,25,50,100],selecting:!0,multiselect:!0,selectingCheckboxes:!0,selectOnRowClick:!1,sorting:!0,defaultSorting:"id ASC",jqueryuiTheme:!0,defaultDateFormat:"dd-mm-yy",gotoPageArea:"none",actions:{listAction:function(b,c){return a.Deferred(function(d){b=a("#mform1").serialize(),a.ajax({url:h+"/local/supervision_tool/ajax.php?action=list&si="+c.jtStartIndex+"&ps="+c.jtPageSize+"&so="+c.jtSorting,type:"POST",dataType:"json",data:b,success:function(a){d.resolve(a)},error:function(){d.reject()}})})}},fields:b,recordsLoaded:function(b,c){a(".jtable-data-row").each(function(){i.indexOf(parseInt(a(this).data("record-key")))>-1&&(a(this).find('input[type="checkbox"]').prop("checked",!0),a(this).addClass("jtable-row-selected ui-state-highlight"))}),k=!1},selectionChanged:function(b,e){if(k)return void(k=!1);var f=d.jtable("selectedRows"),g=[],h=[];a(".jtable-data-row").each(function(){g.push(a(this).data("record-key"))}),f.each(function(){var b=a(this).data("record");"-"!=b.originidentifiant&&b.originidentifiant!=c||h.push(b.localid)});for(var j=0;j<g.length;j++){var l=h.indexOf(""+g[j]),m=l>-1,n=i.indexOf(g[j]),o=n>-1;m&&!o&&i.push(g[j]),!m&&o&&i.splice(n,1)}a('input[name="courseids"]').val(i.join()),a('input[name="actionbutton"]').prop("disabled",0==i.length)}});a("#filterresults").on("dblclick",".commentarea",function(){var b=a(this).parent().data().record;if("-"==b.originidentifiant||b.originidentifiant==c){var d=a("<textarea>").addClass("editcommentarea");"-"!=a(this).text()&&d.val(a(this).text()),a(this).text(""),d.appendTo(a(this)),d.focus()}}),a("#filterresults").on("blur",".editcommentarea",function(){var b=a(this),c={id:b.parents(".jtable-data-row").data("record-key"),comment:b.val()};a.ajax({url:h+"/local/supervision_tool/ajax.php?action=edit",type:"POST",dataType:"json",data:c,success:function(a){var c=b.parent();c.html(a.response)}})}),a("#filterresults").on("click",".jtable-page-number",function(){k=!0}),d.jtable("load")}function f(b){a("#dialog_archive").dialog({autoOpen:!1,width:600,title:"Archivage de la session de formation",draggable:"false",modal:!0,appendTo:"#mform1",resizable:!1,closeOnEscape:!1,closeText:"Fermer",buttons:[{text:"Archiver",id:"archivebutton",click:function(){c=!0,a('input[name="actionbutton"]').click()}},{text:"Annuler",id:"cancelarchivebutton",click:function(){a(this).dialog("close")}}]}),a("#dialog_trash").dialog({autoOpen:!1,width:600,title:"Mise à la corbeille de la session de formation",draggable:"false",modal:!0,appendTo:"#mform1",resizable:!1,closeOnEscape:!1,closeText:"Fermer",buttons:[{text:"Mettre à la corbeille",id:"trashbutton",click:function(){c=!0,a('input[name="actionbutton"]').click()}},{text:"Annuler",id:"canceltrashbutton",click:function(){a(this).dialog("close")}}]}),a("#dialog_migration").dialog({autoOpen:!1,width:600,title:"Conversion de la session de formation",draggable:"false",modal:!0,appendTo:"#mform1",resizable:!1,closeOnEscape:!1,closeText:"Fermer",buttons:[{text:"Lancer la conversion",id:"launchmigration",click:function(){c=!0,a('input[name="actionbutton"]').click()}},{text:"Annuler",id:"cancellaunchmigrationbutton",click:function(){a(this).dialog("close")}}]}),a("#dialog_validation").dialog({autoOpen:!1,width:600,title:"Validation des parcours",draggable:"false",modal:!0,appendTo:"#mform1",resizable:!1,closeOnEscape:!1,closeText:"Fermer",buttons:[{text:"Valider les parcours",id:"validate",click:function(){c=!0,a('input[name="actionbutton"]').click()}},{text:"Annuler",id:"cancelvalidatebutton",click:function(){a(this).dialog("close")}}]}),a("#dialog_moveTo").dialog({autoOpen:!1,width:800,title:"Changement de catégorie",draggable:"false",modal:!0,appendTo:"#mform1",resizable:!1,closeOnEscape:!1,closeText:"Fermer",buttons:[{text:"Déplacer",id:"moveTobutton",click:function(){c=!0,a('input[name="actionbutton"]').click()}},{text:"Annuler",id:"cancelmoveTobutton",click:function(){a(this).dialog("close")}}]});var c=!1;a('input[name="actionbutton"]').click(function(d){if(c)return!0;d.preventDefault();var e=a("select[name='actionTodo'] option:selected").val();e==b.archive?a("#dialog_archive").dialog("open"):e==b.moveTo?a("#dialog_moveTo").dialog("open"):e==b.trash?a("#dialog_trash").dialog("open"):e==b.migrateToModular||e==b.migrateToTopics?a("#dialog_migration").dialog("open"):e==b.validate&&a("#dialog_validation").dialog("open")}),a("#id_resetfilter").click(function(b){b.preventDefault(),a("#id_filter select").prop("selectedIndex",0),a('#id_filter input[type="text"]').val(""),a('#id_filter input[type="checkbox"]').val(""),a("#mform1 #id_filteraction").click()}),a('input[name="csvbutton"]').click(function(b){var c=a("#mform1").serialize();c+="&action=gencsv";var d=a("#filterresults").jtable("instance")._lastSorting;c+=d.length?"&so="+d[0].fieldName+" "+d[0].sortOrder:"&so=undefined",a("body").loadingModal({position:"auto",text:"Génération de l'export CSV en cours",color:"#fff",opacity:"0.7",backgroundColor:"rgb(0,0,0)",animation:"circle"}),a.post(h+"/local/supervision_tool/ajax.php",c,function(b){b=JSON.parse(b),"ok"==b.result&&(window.location.href=b.url,a("body").loadingModal("hide"),setTimeout(function(){a("body").loadingModal("destroy")},1e3))})})}function g(e){var f=[],g=a("#messagemodtext").val();return a.each(e,function(a,b){f.push({touserid:b,text:g})}),d.call([{methodname:"core_message_send_instant_messages",args:{messages:f}}])[0].then(function(c){return a("#messagesmod").dialog("close"),a("#messagemodtext").val(""),1==c.length?b.get_string("sendbulkmessagesentsingle","core_message"):b.get_string("sendbulkmessagesent","core_message",c.length)}).then(function(a){return c.addNotification({message:a,type:"success"}),!0})["catch"](function(d){return a("#messagesmod").dialog("close"),b.get_string("messagefailed","local_supervision_tool").then(function(a){c.addNotification({message:a,type:"failure"})}),!1})}var h=M.cfg.wwwroot,i=[],j=[],k=!1;return a("#messagesmod").dialog({autoOpen:!1,resizable:!1,height:"auto",width:"560px",dialogClass:"ui-new-message-box",modal:!0,buttons:[{text:"Ok","class":"ui-message-ok",click:function(){g(j)}},{text:"Annuler","class":"ui-message-cancel",click:function(){a(this).dialog("close"),a("#messagemodtext").val("")}}]}),a("body").on("click","button.formateurs",function(){j=a(this).attr("data-formateurs-id").split(",");var c="";c=1==j.length?b.get_string("sendbulkmessagesentsingle","core_message"):b.get_string("sendbulkmessagesent","core_message",j.length),c.then(function(b){a(".ui-message-ok").text(b),a(".ui-dialog-title").text(b),a("#messagesmod").dialog("open")}),a("#messagesmod").dialog("open")}),{init:function(b,c,d){var g=a('input[name="'+b+'"]').val();g=JSON.parse(g),e(g,d),f(c)}}});