define(["jquery","jqueryui","local_magisterelib/jquery.loadingModal"],function(a){function b(){a("#wf_dialog_optimize").hide(),a("#wf_dialog_optimize").dialog("close"),q&&null!=q&&"[object Function]"==={}.toString.call(q)&&setTimeout(q,10)}function c(a){for(var b="",c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=c.length,e=0;e<a;e++)b+=c.charAt(Math.floor(Math.random()*d));return b}function d(b){q=b,n=c(25),a("body").loadingModal({position:"auto",text:"Calcul de l'optimisation en cours...",color:"#fff",opacity:"0.7",backgroundColor:"rgb(0,0,0)",animation:"circle"}),a.post(l,'{"module":"getunusedfiles","courseid":'+m+',"session":"'+n+'"}',function(b){0==b.error&&(b.files.length>0?(a("#wf_dialog_optimize_content ul").html(""),a.each(b.files,function(){a("#wf_dialog_optimize_content ul").append('<li><input type="checkbox" id="filecb'+this.id+'" name="files" value="'+this.id+'" checked/><label for="filecb'+this.id+'"> '+this.name+"</label></li>")}),o=!1,g()):(o=!0,e())),a("body").loadingModal("destroy")},"json")}function e(){a("body").loadingModal({position:"auto",text:"Calcul de l'optimisation en cours...",color:"#fff",opacity:"0.7",backgroundColor:"rgb(0,0,0)",animation:"circle"}),a.post(l,'{"module":"getusedfilestoconvert","courseid":'+m+',"session":"'+n+'"}',function(c){0==c.error?c.files.length>0?(a("#wf_dialog_optimize_step2_content ul").html(""),a.each(c.files,function(){a("#wf_dialog_optimize_step2_content ul").append('<li><input type="checkbox" id="filecb'+this.id+'" name="files" value="'+this.id+'" checked/><label for="filecb'+this.id+'"> '+this.name+"</label></li>")}),h(),a("body").loadingModal("destroy")):0==o?(a("body").loadingModal("destroy"),f()):(a("body").loadingModal("destroy"),q&&void 0!=q&&null!=q?(a("body").loadingModal("destroy"),b()):j()):a("body").loadingModal("destroy")},"json")}function f(){a("body").loadingModal({position:"auto",text:"Chargement du résumé des opérations effectuées...",color:"#fff",opacity:"0.7",backgroundColor:"rgb(0,0,0)",animation:"circle"}),a.post(l,'{"module":"getresults","courseid":'+m+',"session":"'+n+'"}',function(b){0==b.error&&(b.file_deleted.length>0?(a("#wf_dialog_optimize_step3_deleted_content ul").html(""),a.each(b.file_deleted,function(){a("#wf_dialog_optimize_step3_deleted_content ul").append("<li>"+this.name+"</li>")}),a("#wf_dialog_optimize_step3_deleted_desc").show(),a("#wf_dialog_optimize_step3_deleted_content").show()):(a("#wf_dialog_optimize_step3_deleted_desc").hide(),a("#wf_dialog_optimize_step3_deleted_content").hide()),b.file_converted.length>0?(a("#wf_dialog_optimize_step3_converted_content ul").html(""),a.each(b.file_converted,function(){a("#wf_dialog_optimize_step3_converted_content ul").append("<li>"+this.name+"</li>")}),a("#wf_dialog_optimize_step3_converted_desc").show(),a("#wf_dialog_optimize_step3_converted_content").show()):(a("#wf_dialog_optimize_step3_converted_desc").hide(),a("#wf_dialog_optimize_step3_converted_content").hide()),b.file_failed.length>0?(a("#wf_dialog_optimize_step3_failed_content ul").html(""),a.each(b.file_failed,function(){a("#wf_dialog_optimize_step3_failed_content ul").append("<li>"+this.name+"</li>")}),a("#wf_dialog_optimize_step3_failed_desc").show(),a("#wf_dialog_optimize_step3_failed_content").show()):(a("#wf_dialog_optimize_step3_failed_desc").hide(),a("#wf_dialog_optimize_step3_failed_content").hide()),i()),a("body").loadingModal("destroy")},"json")}function g(){a("div[aria-describedby=wf_dialog_optimize] .ui-dialog-titlebar-close").hide(),a("#wf_dialog_optimize_step1_button_submit").prop("disabled",!1),a("#wf_dialog_optimize_step1_button_ignore").prop("disabled",!1),a("#wf_dialog_optimize_step2").hide(),a("#wf_dialog_optimize_step3").hide(),a("#wf_dialog_optimize_step1").show(),a("#wf_dialog_optimize_step4").hide(),a("#wf_dialog_optimize").dialog({title:a("#wf_dialog_optimize_step1").attr("data")}),a("#wf_dialog_optimize").dialog({height:350}),a("#wf_dialog_optimize").show(),a("#wf_dialog_optimize").dialog("open")}function h(){a("#wf_dialog_optimize_step2_button_submit").prop("disabled",!1),a("#wf_dialog_optimize_step2_button_ignore").prop("disabled",!1),a("#wf_dialog_optimize_step1").hide(),a("#wf_dialog_optimize_step3").hide(),a("#wf_dialog_optimize_step2").show(),a("#wf_dialog_optimize_step4").hide(),a("#wf_dialog_optimize").dialog({title:a("#wf_dialog_optimize_step2").attr("data")}),a("#wf_dialog_optimize").dialog({height:350}),a("#wf_dialog_optimize").show(),a("#wf_dialog_optimize").dialog("open")}function i(){a("#wf_dialog_optimize_step1").hide(),a("#wf_dialog_optimize_step2").hide(),a("#wf_dialog_optimize_step3").show(),a("#wf_dialog_optimize_step4").hide(),a("#wf_dialog_optimize").dialog({title:a("#wf_dialog_optimize_step3").attr("data")}),a("#wf_dialog_optimize").dialog({height:350}),a("#wf_dialog_optimize").show(),a("#wf_dialog_optimize").dialog("open")}function j(){a("#wf_dialog_optimize_step1").hide(),a("#wf_dialog_optimize_step2").hide(),a("#wf_dialog_optimize_step3").hide(),a("#wf_dialog_optimize_step4").show(),a("#wf_dialog_optimize").dialog({title:a("#wf_dialog_optimize_step4").attr("data")}),a("#wf_dialog_optimize").dialog({height:150}),a("#wf_dialog_optimize").show(),a("#wf_dialog_optimize").dialog("open")}function k(c,g){l=c,m=g,a("#wf_link_optimize").on("click",function(a){a.preventDefault(),d()}),a("#wf_dialog_optimize_step1_button_submit").on("click",function(b){a("#wf_dialog_optimize_step1_button_submit").prop("disabled",!0),a("#wf_dialog_optimize_step1_button_ignore").prop("disabled",!0),a("body").loadingModal({position:"auto",text:"Suppression des fichiers inutilisés",color:"#fff",opacity:"0.7",backgroundColor:"rgb(0,0,0)",animation:"circle"});var c=[];a('#wf_dialog_optimize_content input[type="checkbox"]').each(function(){a(this).is(":checked")&&c.push(this.value)}),a.post(l,'{"module":"deleteunusedfiles","courseid":'+m+',"session":"'+n+'","files":'+JSON.stringify(c)+"}",function(b){0==b.error&&(a("body").loadingModal("destroy"),e())},"json")}),a("#wf_dialog_optimize_step1_button_ignore").on("click",function(b){a("#wf_dialog_optimize_step1_button_submit").prop("disabled",!0),a("#wf_dialog_optimize_step1_button_ignore").prop("disabled",!0),o=!0,e()}),a("#wf_dialog_optimize_step2_button_submit").on("click",function(b){a("#wf_dialog_optimize_step2_button_submit").prop("disabled",!0),a("#wf_dialog_optimize_step2_button_ignore").prop("disabled",!0),a("body").loadingModal({position:"auto",text:"Centralisation des fichiers en cours",color:"#fff",opacity:"0.7",backgroundColor:"rgb(0,0,0)",animation:"circle"});var c=[];a('#wf_dialog_optimize_step2_content input[type="checkbox"]').each(function(){a(this).is(":checked")&&c.push(this.value)}),a.post(l,'{"module":"convertunusedfilestocr","courseid":'+m+',"session":"'+n+'","files":'+JSON.stringify(c)+"}",function(b){a("body").loadingModal("destroy"),0==b.error&&f()},"json")}),a("#wf_dialog_optimize_step2_button_ignore").on("click",function(c){a("#wf_dialog_optimize_step2_button_submit").prop("disabled",!0),a("#wf_dialog_optimize_step2_button_ignore").prop("disabled",!0),p=!0,0==o?f():b()}),a("#wf_dialog_optimize_step3_button_close").on("click",function(a){b()}),a("#wf_dialog_optimize_step4_button_close").on("click",function(a){b()}),a("#wf_dialog_optimize").dialog({autoOpen:!1,width:700,height:350,title:"Optimiser le parcours",draggable:!1,modal:!0,resizable:!1,closeOnEscape:!1,buttons:[]}),a("#wf_link_optimize").prop("disabled",!1)}var l="",m="",n="",o=!1,p=!1,q=void 0;return{init:function(a,b){k(a,b)},load_step1:d}});