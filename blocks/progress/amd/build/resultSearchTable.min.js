define(["jquery","core/str","core/notification","core/ajax","local_magisterelib/jtable"],function(a,b,c,d){function e(c,d,e,j,k,l,m,n,o,p,q,r){var s=[];a("#message_form_div").hide(),a("#ProgressBarOverviewTable").on("mouseout",".progressBarCell",function(){a(".progressEventInfo").empty()}),a("#messagesmod").dialog({autoOpen:!1,resizable:!1,height:"auto",width:"560px",dialogClass:"ui-new-message-box",modal:!0,buttons:[{text:"Ok","class":"ui-message-ok",click:function(){i(s)}},{text:"Annuler","class":"ui-message-cancel",click:function(){a(this).dialog("close")}}]}),a("#select_submit").on("change",function(c){var g=this.value;if("formation_finished"==g){if(""==s)alert("Vous n'avez pas sélectionné d'utilisateur.");else{var h="";a.each(s,function(b,c){return""==c.timeaccess?(a("#page-blocks-progress-warning").show(),window.scrollTo(0,0),!0):(h&&(h+=","),void(h+=c.id))}),""!=h&&a.ajax({type:"POST",url:d,data:{action:"submit_termine",users:h,id:e,courseid:k}}).done(function(a){f()})}a("#select_submit option").filter(function(){return"none"==a(this).val()}).prop("selected",!0)}else if("send_message"==g)if(""==s)alert("Vous n'avez pas sélectionné d'utilisateur.");else{var i="";i=1==s.length?b.get_string("sendbulkmessagesentsingle","core_message"):b.get_string("sendbulkmessagesent","core_message",s.length),i.then(function(b){a(".ui-message-ok").text(b),a(".ui-dialog-title").text(b),a("#messagesmod").dialog("open")})}}),a("#refresh_cache").on("click","",function(b){0==window.is_cachebutton_disable&&a.ajax({type:"POST",url:c,data:{action:"refresh"}}).done(function(a){f(),g()})}),a("#clean_selected_users").click(function(){s=[],a("#ProgressBarOverviewTable").find(".jtable-selecting-column > input:checked").click()}),a("#filterform_submit").click(function(){f()}),a("#filterform_name").keyup(function(a){13==a.keyCode&&f()}),a("#ProgressBarOverviewTable").jtable({title:r,paging:!0,pageSize:20,pageSizes:[20,30,40,60,80,100],selecting:!0,multiselect:!0,selectingCheckboxes:!0,sorting:!0,defaultSorting:"firstname ASC",jqueryuiTheme:!0,defaultDateFormat:"dd-mm-yy",gotoPageArea:"none",selectOnRowClick:!1,actions:{listAction:function(b,d){return a.Deferred(function(f){var g=a("#filterform_role").val(),h=a("#filterform_group").val(),i=a("input[name=filterform_realized]:checked","#filterform_form").val(),l=a("#filterform_activity").val(),m=a("#filterform_name").val(),n="";a("#filterform_neverconnected").is(":checked")&&(n=a("#filterform_neverconnected").val());var o=JSON.stringify(a('input[name^="sgaia"]:checked').serializeArray()),p=1==a('input[name="sother"]:checked').length;b={id:e,courseid:k,contextid:j,role:g,group:h,realized:i,activity:l,name:m,neverconnected:n,sgaia:o,sgaiaother:p},a.ajax({url:c+"?action=list&si="+d.jtStartIndex+"&ps="+d.jtPageSize+"&so="+d.jtSorting,type:"POST",dataType:"json",data:b,success:function(a){f.resolve(a)},error:function(){f.reject()}})})}},selectionChanged:function(){for(var b=a("#ProgressBarOverviewTable").jtable("selectedRows"),c=[],d=0,e=s.length;d<e;d++)$row=a("#ProgressBarOverviewTable").jtable("getRowByKey",s[d].id),$row||c.push(s[d]);s=c,b.length>0&&b.each(function(){var b=a(this).data("record");h(s,b.id)||s.push(b)}),a("#selected_users span").text(s.length)},rowInserted:function(b,c){h(s,c.record.id)&&a("#ProgressBarOverviewTable").jtable("selectRows",c.row)},fields:{id:{title:"id",key:!0,create:!1,edit:!1,list:!1},firstname:{title:l,width:"13%",create:!1,edit:!1,list:!0},lastname:{title:m,width:"19%",create:!1,edit:!1,list:!0},timeaccess:{title:n,width:"21%",type:"date",columnResizable:!1,listClass:"jt_lastlogin",create:!1,edit:!1,list:!0},suivi:{title:o,width:"23%",listClass:"jt_suivi",create:!1,edit:!1,list:!0,sorting:!1},progression:{title:p,width:"5%",create:!1,edit:!1,list:!0,sorting:!1},finished:{title:q,width:"10%",create:!1,edit:!1,list:!0}}}),a("#ProgressBarOverviewTable").jtable("load")}function f(){a("#ProgressBarOverviewTable").jtable("load")}function g(){window.is_cachebutton_disable=!0,a("#refresh_cache").css("filter","grayscale(100%)"),a("#refresh_cache").css("-webkit-filter","grayscale(100%)"),a("#refresh_cache").css("-moz-filter","grayscale(100%)"),a("#refresh_cache").css("filter","opacity(30%)"),a("#refresh_cache").css("-webkit-filter","opacity(30%)"),a("#refresh_cache").css("-moz-filter","opacity(30%)"),a("#refresh_cache").css("cursor","auto"),setTimeout("enable_cachebutton()",6e4)}function h(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c].id==b)return!0;return!1}function i(e){var f=[],g=a("#messagemodtext").val();return a.each(e,function(a,b){f.push({touserid:b.id,text:g})}),d.call([{methodname:"core_message_send_instant_messages",args:{messages:f}}])[0].then(function(c){return a("#messagesmod").dialog("close"),1==c.length?b.get_string("sendbulkmessagesentsingle","core_message"):b.get_string("sendbulkmessagesent","core_message",c.length)}).then(function(a){return c.addNotification({message:a,type:"success"}),!0})["catch"](c.exception)}return window.is_cachebutton_disable=!1,{init:function(a,b,c,d,f,g,h,i,j,k,l,m){e(a,b,c,d,f,g,h,i,j,k,l,m)}}});