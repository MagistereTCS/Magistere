define(["jquery","core/str","core/templates","core/notification","core/ajax","local_magisterelib/jtable"],function(a,b,c,d,e){function f(c,d,e,f,k,l,m,n,o,p,q,r){var s=[];a("#message_form_div").hide(),a("#ProgressBarOverviewTable").on("mouseout",".progressBarCell",function(){a(".progressEventInfo:not(:first)").attr("style","display: none;")}),a("#messagesmod").dialog({autoOpen:!1,resizable:!1,height:"auto",width:"560px",dialogClass:"ui-new-message-box",modal:!0,buttons:[{text:"Ok","class":"ui-message-ok",click:function(){j(s)}},{text:"Annuler","class":"ui-message-cancel",click:function(){a(this).dialog("close")}}]}),a("#select_submit").on("change",function(c){var f=this.value;if("formation_finished"==f)""==s?alert("Vous n'avez pas sélectionné d'utilisateur."):(a("#selected-participants-list ul").empty(),a(s).each(function(b,c){a("#selected-participants-list ul").append("<li>"+c.firstname+" "+c.lastname+"</li>")}),a("#dialog-formation-finished").dialog({resizable:!1,width:600,height:"auto",maxHeight:470,modal:!0,closeOnEscape:!1,buttons:[{text:"Valider",click:function(){var b="",c=!1;a.each(s,function(d,e){return""==e.timeaccess?(a("#page-blocks-progress-warning").show(),c=!0,!0):(b&&(b+=","),void(b+=e.id))}),""!=b&&a.ajax({type:"POST",url:d,data:{action:"submit_termine",users:b,id:e,courseid:k}}).done(function(a){g()}),a(this).dialog("close"),c&&window.scrollTo(0,0)}},{text:"Annuler",click:function(){a(this).dialog("close")}}]})),a("#select_submit option").filter(function(){return"none"==a(this).val()}).prop("selected",!0);else if("send_message"==f)if(""==s)alert("Vous n'avez pas sélectionné d'utilisateur.");else{var h="";h=1==s.length?b.get_string("sendbulkmessagesentsingle","core_message"):b.get_string("sendbulkmessagesent","core_message",s.length),h.then(function(b){a(".ui-message-ok").text(b),a(".ui-dialog-title").text(b),a("#messagesmod").dialog("open")})}}),a("#refresh_cache").on("click","",function(b){0==window.is_cachebutton_disable&&a.ajax({type:"POST",url:c,data:{action:"refresh"}}).done(function(a){g(),h()})}),a("#clean_selected_users").click(function(){s=[],a("#ProgressBarOverviewTable").find(".jtable-selecting-column > input:checked").click()}),a("#filterform_submit").click(function(){g()}),a("#filterform_name").keyup(function(a){13==a.keyCode&&g()}),a("#ProgressBarOverviewTable").jtable({title:r,paging:!0,pageSize:20,pageSizes:[20,30,40,60,80,100],selecting:!0,multiselect:!0,selectingCheckboxes:!0,sorting:!0,defaultSorting:"firstname ASC",jqueryuiTheme:!0,defaultDateFormat:"dd-mm-yy",gotoPageArea:"none",selectOnRowClick:!1,actions:{listAction:function(b,d){return a.Deferred(function(g){var h=a("#filterform_role").val(),i=a("#filterform_group").val(),j=a("input[name=filterform_realized]:checked","#filterform_form").val(),l=a("#filterform_activity").val(),m=a("#filterform_name").val(),n="";a("#filterform_neverconnected").is(":checked")&&(n=a("#filterform_neverconnected").val());var o=JSON.stringify(a('input[name^="sgaia"]:checked').serializeArray()),p=1==a('input[name="sother"]:checked').length;b={id:e,courseid:k,contextid:f,role:h,group:i,realized:j,activity:l,name:m,neverconnected:n,sgaia:o,sgaiaother:p},a.ajax({url:c+"?action=list&si="+d.jtStartIndex+"&ps="+d.jtPageSize+"&so="+d.jtSorting,type:"POST",dataType:"json",data:b,success:function(a){g.resolve(a)},error:function(){g.reject()}})})}},selectionChanged:function(){for(var b=a("#ProgressBarOverviewTable").jtable("selectedRows"),c=[],d=0,e=s.length;d<e;d++)$row=a("#ProgressBarOverviewTable").jtable("getRowByKey",s[d].id),$row||c.push(s[d]);s=c,b.length>0&&b.each(function(){var b=a(this).data("record");i(s,b.id)||s.push(b)}),a("#selected_users span").text(s.length)},rowInserted:function(b,c){i(s,c.record.id)&&a("#ProgressBarOverviewTable").jtable("selectRows",c.row)},fields:{id:{title:"id",key:!0,create:!1,edit:!1,list:!1},firstname:{title:l,width:"13%",create:!1,edit:!1,list:!0},lastname:{title:m,width:"19%",create:!1,edit:!1,list:!0},timeaccess:{title:n,width:"21%",type:"date",columnResizable:!1,listClass:"jt_lastlogin",create:!1,edit:!1,list:!0},suivi:{title:o,width:"23%",listClass:"jt_suivi",create:!1,edit:!1,list:!0,sorting:!1},progression:{title:p,width:"5%",create:!1,edit:!1,list:!0,sorting:!1},finished:{title:q,width:"10%",create:!1,edit:!1,list:!0}}}),a("#ProgressBarOverviewTable").jtable("load")}function g(){a("#ProgressBarOverviewTable").jtable("load")}function h(){window.is_cachebutton_disable=!0,a("#refresh_cache").css("filter","grayscale(100%)"),a("#refresh_cache").css("-webkit-filter","grayscale(100%)"),a("#refresh_cache").css("-moz-filter","grayscale(100%)"),a("#refresh_cache").css("filter","opacity(30%)"),a("#refresh_cache").css("-webkit-filter","opacity(30%)"),a("#refresh_cache").css("-moz-filter","opacity(30%)"),a("#refresh_cache").css("cursor","auto"),setTimeout("enable_cachebutton()",6e4)}function i(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c].id==b)return!0;return!1}function j(c){var f=[],g=a("#messagemodtext").val();return a.each(c,function(a,b){f.push({touserid:b.id,text:g})}),e.call([{methodname:"core_message_send_instant_messages",args:{messages:f}}])[0].then(function(c){return a("#messagesmod").dialog("close"),1==c.length?b.get_string("sendbulkmessagesentsingle","core_message"):b.get_string("sendbulkmessagesent","core_message",c.length)}).then(function(a){return d.addNotification({message:a,type:"success"}),!0})["catch"](d.exception)}return window.is_cachebutton_disable=!1,{init:function(a,b,c,d,e,g,h,i,j,k,l,m){f(a,b,c,d,e,g,h,i,j,k,l,m)}}});